name: Deploy Production

on:
  push:
    tags:
      - "v*" # vA.B.C : A+1 New "big" version, B+1 change in app, c+1 fixes or patches etc

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Deploy Script via SSH
        uses: appleboy/ssh-action@master

        env:
          AGENCY_SANITY_PROJECT_ID: ${{ secrets.AGENCY_SANITY_PROJECT_ID }}
          AGENCY_SANITY_DATASET: ${{ secrets.AGENCY_SANITY_DATASET }}
          AGENCY_SANITY_STUDIO_APP_ID: ${{ secrets.AGENCY_SANITY_STUDIO_APP_ID }}
          AGENCY_SANITY_API_VERSION: ${{ secrets.AGENCY_SANITY_API_VERSION }}

        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22

          envs: AGENCY_SANITY_PROJECT_ID,AGENCY_SANITY_DATASET,AGENCY_SANITY_STUDIO_APP_ID,AGENCY_SANITY_API_VERSION

          script: |
            set -e
            export PATH=$PATH:/usr/bin

            cd /var/www/ecosystem

            echo "‚¨áÔ∏è Pulling latest code..."
            git fetch origin production
            git reset --hard origin/production

            echo "üîë Injecting Secrets..."
            echo "AGENCY_SANITY_PROJECT_ID=$AGENCY_SANITY_PROJECT_ID"
            echo "AGENCY_SANITY_DATASET=$AGENCY_SANITY_DATASET"
            echo "AGENCY_SANITY_STUDIO_APP_ID=$AGENCY_SANITY_STUDIO_APP_ID"
            echo "AGENCY_SANITY_API_VERSION=$AGENCY_SANITY_API_VERSION"

            chmod +x scripts/deploy.sh
            bash scripts/deploy.sh
