name: Deploy Production

on:
  push:
    tags:
      - "v*" # vA.B.C : A+1 New "big" version, B+1 change in app, c+1 fixes or patches etc

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Deploy Script via SSH
        uses: appleboy/ssh-action@master

        env:
          SANITY_STUDIO_AGENCY_PROJECT_ID: ${{ secrets.SANITY_STUDIO_AGENCY_PROJECT_ID }}
          SANITY_STUDIO_AGENCY_DATASET: ${{ secrets.SANITY_STUDIO_AGENCY_DATASET }}
          SANITY_STUDIO_AGENCY_STUDIO_APP_ID: ${{ secrets.SANITY_STUDIO_AGENCY_STUDIO_APP_ID }}
          SANITY_STUDIO_AGENCY_API_VERSION: ${{ secrets.SANITY_STUDIO_AGENCY_API_VERSION }}

        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22

          envs: SANITY_STUDIO_AGENCY_PROJECT_ID,SANITY_STUDIO_AGENCY_DATASET,SANITY_STUDIO_AGENCY_STUDIO_APP_ID,SANITY_STUDIO_AGENCY_API_VERSION

          script: |
            set -e
            export PATH=$PATH:/usr/bin

            cd /var/www/ecosystem

            echo "‚¨áÔ∏è Pulling latest code..."
            git fetch origin production
            git reset --hard origin/production

            echo "üîë Injecting Secrets..."
            echo "SANITY_STUDIO_AGENCY_PROJECT_ID=$SANITY_STUDIO_AGENCY_PROJECT_ID"
            echo "SANITY_STUDIO_AGENCY_DATASET=$SANITY_STUDIO_AGENCY_DATASET"
            echo "SANITY_STUDIO_AGENCY_STUDIO_APP_ID=$SANITY_STUDIO_AGENCY_STUDIO_APP_ID"
            echo "SANITY_STUDIO_AGENCY_API_VERSION=$SANITY_STUDIO_AGENCY_API_VERSION"

            chmod +x scripts/deploy.sh
            bash scripts/deploy.sh
