name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master

        env:
          AGENCY_SANITY_PROJECT_ID: ${{ secrets.AGENCY_SANITY_PROJECT_ID }}
          AGENCY_SANITY_DATASET: ${{ secrets.AGENCY_SANITY_DATASET }}
          AGENCY_SANITY_API_VERSION: ${{ secrets.AGENCY_SANITY_API_VERSION }}

        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22

          # 2. Pass Secrets to the Server Script
          envs: AGENCY_SANITY_PROJECT_ID,AGENCY_SANITY_DATASET,AGENCY_SANITY_API_VERSION

          script: |
            # stops the script on any error
            set -e

            export PATH=$PATH:/usr/bin

            cd /var/www/ecosystem

            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin production
            git checkout production
            git pull origin production

            cd agency

            echo "ğŸ”‘ Injecting Secrets..."
            echo "AGENCY_SANITY_PROJECT_ID=$AGENCY_SANITY_PROJECT_ID" > .env.local
            echo "AGENCY_SANITY_DATASET=$AGENCY_SANITY_DATASET" >> .env.local
            echo "AGENCY_SANITY_API_VERSION=$AGENCY_SANITY_API_VERSION" >> .env.local

            echo "ğŸ“¦ Installing Dependencies..."
            npm ci --legacy-peer-deps

            echo "ğŸ—ï¸ Building Next.js..."
            npm run build

            echo "ğŸš€ Reloading PM2..."
            pm2 reload agency --update-env

            echo "âœ… Deployment Success!"
