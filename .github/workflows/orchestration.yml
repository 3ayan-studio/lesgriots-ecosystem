name: Orchestration

on:
  push:
    tags:
      - "v*" # Triggers on v1.0, v20.15.10, etc. NO SLASHES ONLY INTERGERS, DOTS IN BETWEEN

jobs:
  # --- PHASE 1: BUILD & TEST (Parallel) ---
  check-agency:
    uses: ./.github/workflows/build-agency.yml
    secrets: inherit

  check-studio:
    uses: ./.github/workflows/build-studio.yml
    secrets: inherit

  # --- PHASE 2: SETUP FILES AND DIRECTORIES ---
  stage-release:
    needs: [check-agency, check-studio]
    uses: ./.github/workflows/stage-release.yml

  # --- PHASE 3: ATOMIC DEPLOY (Sequential) ---
  deploy-agency:
    needs: check-agency
    uses: ./.github/workflows/deploy-agency.yml
    secrets: inherit

  deploy-studio:
    needs: setup-directories
    uses: ./.github/workflows/deploy-studio.yml
    secrets: inherit

  # --- PHASE 4: WARM UP CACHE ---
  post-deployment:
    needs: setup-directories
    uses: ./.github/workflows/post-deployment.yml
